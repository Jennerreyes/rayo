add_action('woocommerce_before_product_object_save', function($product) {
    global $wpdb;

    $sku = $product->get_sku();
    $product_id = $product->get_id();

    if ($sku) {
        $query = $wpdb->get_var($wpdb->prepare("
            SELECT ID FROM {$wpdb->posts} 
            WHERE post_type = 'product' AND ID != %d AND post_status = 'publish' 
            AND ID IN (
                SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_sku' AND meta_value = %s
            )
        ", $product_id, $sku));

        if ($query) {
            throw new Exception(__('Error: Ya existe un producto con el mismo SKU.', 'woocommerce'));
        }
    }
});
